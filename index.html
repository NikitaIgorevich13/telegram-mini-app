<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Tracker Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ---------- BASE & RESET ---------- */
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,.1)}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;
            background:#ffffff;color:#000;overflow-x:hidden;-webkit-font-smoothing:antialiased
        }
        .app{min-height:100vh;background:#f2f2f7}
        /* ---------- HEADER ---------- */
        .header{background:#fff;padding:16px;box-shadow:0 1px 0 0 rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
        .user-info{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .avatar{width:48px;height:48px;border-radius:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
        .user-details{flex:1}
        .user-name{font-size:18px;font-weight:600}
        .user-rank{font-size:14px;color:#8e8e93;margin-top:2px}
        .stats-row{display:flex;gap:20px}
        .stat-item{display:flex;align-items:center;gap:6px;font-size:15px}
        .stat-value{font-weight:600}
        /* ---------- CALENDAR ---------- */
        .calendar-section{background:#fff;margin:16px;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .month-navigation{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .month-title{font-size:18px;font-weight:600;text-transform:capitalize}
        .nav-btn{width:36px;height:36px;border:none;background:#007aff;color:#fff;border-radius:18px;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity .2s}
        .nav-btn:active{opacity:.7}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .weekday-label{text-align:center;font-size:12px;color:#8e8e93;font-weight:500;padding:8px 0}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;position:relative;background:#f2f2f7;transition:all .2s}
        .calendar-day:active{transform:scale(.95)}
        .calendar-day.other-month{opacity:.3}
        .calendar-day.today{background:#e5f1ff;color:#007aff;font-weight:600}
        .calendar-day.selected{background:#007aff;color:#fff}
        .day-number{font-size:15px}
        .task-dots{position:absolute;bottom:4px;display:flex;gap:2px}
        .task-dot{width:4px;height:4px;border-radius:2px;background:#8e8e93}
        .task-dot.completed{background:#34c759}
        /* ---------- TASKS ---------- */
        .tasks-section{margin:16px}
        .tasks-header{font-size:20px;font-weight:600;margin-bottom:16px;padding:0 4px}
        .task-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;align-items:flex-start;gap:12px;transition:opacity .2s}
        .task-card.completed{opacity:.6}
        .checkbox{width:24px;height:24px;border:2px solid #007aff;border-radius:6px;flex-shrink:0;cursor:pointer;position:relative;transition:all .2s;user-select:none}
        .checkbox.checked{background:#007aff;border-color:#007aff}
        .checkbox.checked:after{content:"";position:absolute;left:7px;top:3px;width:6px;height:12px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}
        .task-info{flex:1}
        .task-title{font-size:16px;font-weight:500;margin-bottom:6px;line-height:1.3}
        .task-title.completed{text-decoration:line-through}
        .task-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:13px;color:#8e8e93}
        .priority-badge{padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500;color:#fff}
        .priority-high{background:#ff3b30}.priority-medium{background:#ff9500}.priority-low{background:#34c759}
        .empty-state{text-align:center;padding:60px 20px;color:#8e8e93}
        .empty-icon{font-size:64px;margin-bottom:16px;opacity:.5}
        .empty-title{font-size:18px;font-weight:500;margin-bottom:8px}
        .empty-subtitle{font-size:14px}
        .loading-container{display:flex;justify-content:center;align-items:center;min-height:200px}
        .spinner{width:40px;height:40px;border:3px solid #f2f2f7;border-top-color:#007aff;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* ---------- FAB ---------- */
        .fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:#007aff;color:#fff;border:none;border-radius:28px;font-size:28px;box-shadow:0 4px 12px rgba(0,122,255,.3);cursor:pointer;transition:transform .2s;display:flex;align-items:center;justify-content:center;z-index:1000}
        .fab:active{transform:scale(.9)}
        .error-message{background:#ff3b30;color:#fff;padding:12px 16px;margin:16px;border-radius:8px;font-size:14px}
    </style>
</head>
<body>
<div id="app" class="app">
    <!-- HEADER -->
    <div class="header">
        <div class="user-info">
            <div class="avatar" id="userAvatar">–£</div>
            <div class="user-details">
                <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="user-rank" id="userRank">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-item"><span>üèÜ</span><span class="stat-value" id="userPoints">0</span></div>
            <div class="stat-item"><span>üî•</span><span class="stat-value" id="userStreak">0</span><span>–¥–Ω–µ–π</span></div>
        </div>
    </div>

    <!-- CALENDAR -->
    <div class="calendar-section">
        <div class="month-navigation">
            <button class="nav-btn" onclick="changeMonth(-1)">‚Üê</button>
            <div class="month-title" id="monthTitle">–Ø–Ω–≤–∞—Ä—å 2025</div>
            <button class="nav-btn" onclick="changeMonth(1)">‚Üí</button>
        </div>
        <div class="calendar-grid" id="calendar"></div>
    </div>

    <!-- TASKS -->
    <div class="tasks-section">
        <div class="tasks-header" id="tasksHeader">–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
        <div id="tasksList"><div class="loading-container"><div class="spinner"></div></div></div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="addNewTask()">+</button>
</div>

<script>
/***************** CONFIG *****************/
const API_ENDPOINTS={
    user:'https://nbykanov13.app.n8n.cloud/webhook/ec48838c-e168-4f0e-bf66-054d59e0275a/api/user',
    tasks:'https://nbykanov13.app.n8n.cloud/webhook/2fd6cb69-88fa-4d08-aba2-221247b6652b/api/tasks',
    calendar:'https://nbykanov13.app.n8n.cloud/webhook/a8c27692-17b1-45f8-a11f-0e5a7063a5ed/api/calendar',
    toggleTask:'https://nbykanov13.app.n8n.cloud/webhook/a3911d71-ce2f-4e9c-a05d-f35f1c4779c8/api/tasks'
};

/***************** TELEGRAM INIT *****************/
let tg=null,telegramUserId=null;
if(window.Telegram&&window.Telegram.WebApp){tg=Telegram.WebApp;tg.ready();tg.expand();telegramUserId=tg.initDataUnsafe?.user?.id}
if(!telegramUserId){telegramUserId=parseInt(new URLSearchParams(location.search).get('user_id'))||123456789}

/***************** STATE *****************/
const today=new Date();
let currentDate=new Date(),selectedDate=new Date();
let calendarData={},currentTasks=[],userInfo={name:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',rank:'–ö–æ–∂–∞–Ω—ã–π –º–µ—à–æ–∫',points:0,streak:0};

const $=id=>document.getElementById(id);
const formatKey=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

/***************** API WRAPPER *****************/
async function api(url,opt={}){const r=await fetch(url,{headers:{'Content-Type':'application/json'},...opt});if(!r.ok)throw new Error(r.status);return r.json();}

/***************** LOAD DATA *****************/
async function loadUser(){try{const d=await api(`${API_ENDPOINTS.user}/${telegramUserId}`);const u=Array.isArray(d)?d[0]:d;userInfo={name:u.first_name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',rank:u.rank||'–ö–æ–∂–∞–Ω—ã–π –º–µ—à–æ–∫',points:+u.points||0,streak:+u.current_streak||0};updateUserUI();}catch{}}
async function loadCalendar(){try{const y=currentDate.getFullYear(),m=currentDate.getMonth()+1;const data=await api(`${API_ENDPOINTS.calendar}/${telegramUserId}/${y}/${m}`);calendarData={};(Array.isArray(data)?data:[data]).filter(Boolean).forEach(day=>{calendarData[formatKey(new Date(day.date))]={total:+day.total_tasks||0,completed:+day.completed_tasks||0}});}catch{calendarData={}}renderCalendar();}
async function loadTasks(){try{const dateStr=formatKey(selectedDate);const res=await api(`${API_ENDPOINTS.tasks}/${telegramUserId}/${dateStr}`);const arr=Array.isArray(res)?res:(res? [res]:[]);currentTasks=arr.map(t=>({...t,id:Number(t.id)}));renderTasks();}catch{currentTasks=[];renderTasks();}}

/***************** RENDERERS *****************/
function updateUserUI(){$('userName').textContent=userInfo.name;$('userRank').textContent=userInfo.rank;$('userPoints').textContent=userInfo.points;$('userStreak').textContent=userInfo.streak;$('userAvatar').textContent=userInfo.name[0]?.toUpperCase()||'–ü';}
function renderCalendar(){const y=currentDate.getFullYear(),m=currentDate.getMonth();$('monthTitle').textContent=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'][m]+' '+y;const first=new Date(y,m,1),last=new Date(y,m+1,0),prevLast=new Date(y,m,0);const startDow=first.getDay(),days=last.getDate();let html='';['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'].forEach(d=>html+=`<div class="weekday-label">${d}</div>`);for(let i=startDow-1;i>=0;i--){html+=`<div class="calendar-day other-month"><span class="day-number">${prevLast.getDate()-i}</span></div>`;}for(let d=1;d<=days;d++){const date=new Date(y,m,d),key=formatKey(date);const cls=['calendar-day'];if(date.toDateString()===today.toDateString())cls.push('today');if(date.toDateString()===selectedDate.toDateString())cls.push('selected');html+=`<div class="${cls.join(' ')}" onclick="selectDate(${y},${m},${d})"><span class="day-number">${d}</span>`;const data=calendarData[key];if(data?.total){html+='<div class="task-dots">';for(let i=0;i<Math.min(data.total,3);i++){html+=`<div class="task-dot ${i<data.completed?'completed':''}"></div>`;}html+='</div>';}html+='</div>';}
const rem=42-(startDow+days);for(let d=1;d<=rem;d++){html+=`<div class="calendar-day other-month"><span class="day-number">${d}</span></div>`;}$('calendar').innerHTML=html;}
function renderTasks(){const container=$('tasksList');const opts={weekday:'long',day:'numeric',month:'long'};$('tasksHeader').textContent=selectedDate.toLocaleDateString('ru-RU',opts);if(!currentTasks.length){container.innerHTML='<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-title">–ù–µ—Ç –∑–∞–¥–∞—á</div><div class="empty-subtitle">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞</div></div>';return;}container.innerHTML=currentTasks.map(t=>{const done=t.status==='completed';const pr={'high':'–í—ã—Å–æ–∫–∏–π','medium':'–°—Ä–µ–¥–Ω–∏–π','low':'–ù–∏–∑–∫–∏–π'}[t.priority]||'–ë–µ–∑ –ø—Ä–∏–æ—Ä.';const time=t.deadline?new Date(t.deadline).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}):'';return`<div class="task-card ${done?'completed':''}" data-task-id="${t.id}" onclick="cardToggle(event,${t.id})"><div class="checkbox ${done?'checked':''}" data-task-id="${t.id}" onclick="toggleTaskStatus(event,${t.id})"></div><div class="task-info"><div class="task-title ${done?'completed':''}">${t.title}</div><div class="task-meta">${time?`<span>‚è∞ ${time}</span>`:''}<span class="priority-badge priority-${t.priority}">${pr}</span>${t.points_earned?`<span>üèÜ ${t.points_earned} –æ—á–∫–æ–≤</span>`:''}</div></div></div>`}).join('');}

/***************** ACTIONS *****************/
function cardToggle(e,id){if(e.target.classList.contains('checkbox'))return;toggleTaskStatus(e,id);} // click on card except checkbox
async function toggleTaskStatus(e,id){if(e) e.stopPropagation();id=Number(id);const task=currentTasks.find(t=>t.id===id);if(!task)return;const done=task.status==='completed';task.status=done?'pending':'completed';renderTasks();tg?.HapticFeedback?.impactOccurred('light');try{await api(`${API_ENDPOINTS.toggleTask}/${id}/toggle',{method:'POST',body:JSON.stringify({task_id:id,user_id:telegramUserId})});loadCalendar();if(!done)loadUser();}catch{task.status=done?'completed':'pending';renderTasks();}}

/***************** NAVIGATION *****************/
function changeMonth(dir){currentDate.setMonth(currentDate.getMonth()+dir);loadCalendar();}
function selectDate(y,m,d){selectedDate=new Date(y,m,d);renderCalendar();loadTasks();}
function addNewTask(){tg?.HapticFeedback?.impactOccurred('medium');if(tg){tg.sendData(`add_task_${formatKey(selectedDate)}`);tg.close();}else alert('–¢–æ–ª—å–∫–æ –≤ Telegram');}

/***************** INIT *****************/
(async ()=>{updateUserUI();renderCalendar();await loadUser();await loadCalendar();await loadTasks();})();
</script>
</body>
</html>

// –ù–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é toggleTaskStatus (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 1090) –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –µ—ë –Ω–∞ —ç—Ç—É:

window.toggleTaskStatus = async function(taskId, action = 'toggle') {
    try {
        debugLog(`Processing task ${taskId} with action: ${action}`, 'info');
        
        const task = currentTasks.find(t => t.id === taskId);
        if (!task && action === 'toggle') {
            debugLog('Task not found in UI', 'error');
            return;
        }
        
        // –î–ª—è toggle –¥–µ–ª–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        if (action === 'toggle') {
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            const checkbox = taskCard.querySelector('.checkbox');
            const taskTitle = taskCard.querySelector('.task-title');
            
            const wasCompleted = task.status === 'completed';
            const newStatus = wasCompleted ? 'pending' : 'completed';
            
            // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ø–∞–º—è—Ç–∏ —Å—Ä–∞–∑—É!
            task.status = newStatus;
            
            if (wasCompleted) {
                checkbox.classList.remove('checked');
                taskCard.classList.remove('completed');
                taskTitle.style.textDecoration = 'none';
            } else {
                checkbox.classList.add('checked');
                taskCard.classList.add('completed');
                taskTitle.style.textDecoration = 'line-through';
            }
            
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('light');
                } catch (e) {}
            }
            
            showSuccess(wasCompleted ? '–ó–∞–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É' : '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        let requestBody = {
            user_id: telegramUserId,
            action: action
        };
        
        if (action === 'toggle') {
            requestBody.status = task.status; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        } else if (action === 'update' && editingTask) {
            requestBody = {
                ...requestBody,
                title: editingTask.title,
                deadline: editingTask.deadline,
                priority: editingTask.priority,
                difficulty: editingTask.difficulty || 'medium',
                has_specific_time: editingTask.has_specific_time
            };
        } else if (action === 'delete' && editingTask) {
            // –î–ª—è delete –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ user_id
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω—É–∂–Ω—ã–º action
        const actionUrl = `${API_ENDPOINTS.toggleTask}/${taskId}/${action}`;
        await apiRequest(actionUrl, {
            method: 'POST',
            body: JSON.stringify(requestBody)
        });
        
        debugLog(`Task ${action} completed successfully`, 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ–Ω–µ –ë–ï–ó –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –¥–ª—è toggle
        if (action === 'toggle') {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ–Ω–µ
            setTimeout(async () => {
                try {
                    await loadCalendarData();
                    await loadUserData();
                    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º loadTasks() –¥–ª—è toggle!
                } catch (e) {
                    console.log('Background update error:', e);
                }
            }, 500);
        } else {
            // –î–ª—è update –∏ delete –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë
            await loadTasks();
            await loadCalendarData();
            await loadUserData();
        }
        
    } catch (error) {
        debugLog(`${action} error: ${error.message}`, 'error');
        showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ ${action === 'toggle' ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏' : action === 'delete' ? '—É–¥–∞–ª–µ–Ω–∏–∏' : '–∏–∑–º–µ–Ω–µ–Ω–∏–∏'} –∑–∞–¥–∞—á–∏`);
        
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (action === 'toggle' && task) {
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ø–∞–º—è—Ç–∏
            task.status = task.status === 'completed' ? 'pending' : 'completed';
        }
        
        await loadTasks();
        await loadUserData();
    }
};

// –¢–∞–∫–∂–µ –Ω–∞–π–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é renderTasks (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 1650) –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è UI —Å–æ—Å—Ç–æ—è–Ω–∏—è:

function renderTasks(tasks) {
    const container = document.getElementById('tasksList');
    
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('tasksHeader').textContent = 
        selectedDate.toLocaleDateString('ru-RU', options);
    
    const selectedDateStr = formatDateKey(selectedDate);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
    const uiStates = {};
    document.querySelectorAll('.task-card').forEach(card => {
        const taskId = card.dataset.taskId;
        const checkbox = card.querySelector('.checkbox');
        uiStates[taskId] = {
            isChecked: checkbox.classList.contains('checked'),
            isCompleted: card.classList.contains('completed')
        };
    });
    
    const filteredTasks = tasks.filter(task => {
        if (!task) return false;
        
        const taskDate = task.deadline ? 
            formatDateKey(new Date(task.deadline)) : 
            formatDateKey(new Date(task.created_at));
        
        return taskDate === selectedDateStr;
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ UI —Å –¥–∞–Ω–Ω—ã–º–∏
    filteredTasks.forEach(task => {
        const uiState = uiStates[task.id];
        if (uiState && uiState.isChecked !== undefined) {
            // –ï—Å–ª–∏ UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (uiState.isChecked && task.status !== 'completed') {
                task.status = 'completed';
            } else if (!uiState.isChecked && task.status === 'completed') {
                task.status = 'pending';
            }
        }
    });
    
    currentTasks = filteredTasks;
    
    if (filteredTasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <div class="empty-title">–ù–µ—Ç –∑–∞–¥–∞—á</div>
                <div class="empty-subtitle">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredTasks.forEach(task => {
        const isCompleted = task.status === 'completed';
        const priorityText = task.priority === 'high' ? '–í—ã—Å–æ–∫–∏–π' : 
                           task.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π';
        
        let deadlineText = '';
        if (task.deadline) {
            const deadline = new Date(task.deadline);
            deadlineText = deadline.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        const safeTitle = escapeHtml(task.title || '');
        
        html += `
            <div class="task-card ${isCompleted ? 'completed' : ''}" 
                 data-task-id="${task.id}"
                 ontouchstart="handleTouchStart(event, this)"
                 ontouchmove="handleTouchMove(event, this)"
                 ontouchend="handleTouchEnd(event, this)">
                <div class="checkbox ${isCompleted ? 'checked' : ''}" 
                     onclick="toggleTaskStatus('${task.id}')">
                </div>
                <div class="task-info">
                    <div class="task-title" style="text-decoration: ${isCompleted ? 'line-through' : 'none'}">${safeTitle}</div>
                    <div class="task-meta">
                        ${deadlineText ? `<span>‚è∞ ${deadlineText}</span>` : ''}
                        <span class="priority-badge priority-${task.priority}">${priorityText}</span>
                        <span>üèÜ ${task.points_earned || 0} –æ—á–∫–æ–≤</span>
                    </div>
                </div>
                <div class="task-actions" onclick="deleteTaskSwipe('${task.id}')">
                    –£–¥–∞–ª–∏—Ç—å
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// –î–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏:

// Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// –°–æ–∑–¥–∞–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
const debouncedLoadCalendar = debounce(loadCalendarData, 1000);
const debouncedLoadUser = debounce(loadUserData, 1000);

// –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é refreshData –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏:
window.refreshData = async function() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.classList.add('spinning');
    
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º
        showSuccess('–û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
        
        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        const [userData, calendarData, tasksData] = await Promise.all([
            loadUserData(),
            loadCalendarData(), 
            loadTasks()
        ]);
        
        // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ
        setTimeout(() => {
            showSuccess('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        }, 100);
        
    } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
    } finally {
        refreshBtn.classList.remove('spinning');
    }
    
    if (tg && tg.HapticFeedback && typeof tg.HapticFeedback.impactOccurred === 'function') {
        try {
            tg.HapticFeedback.impactOccurred('light');
        } catch (e) {}
    }
};

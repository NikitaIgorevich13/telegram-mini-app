<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Task¬†Tracker¬†Mini¬†App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* BASE -------------------------------------------------- */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:#fff;color:#000;overflow-x:hidden;-webkit-font-smoothing:antialiased}
    .app{min-height:100vh;background:#f2f2f7}
    /* HEADER ------------------------------------------------ */
    .header{background:#fff;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
    .user-info{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .avatar{width:48px;height:48px;border-radius:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
    .user-name{font-size:18px;font-weight:600}
    .user-rank{font-size:14px;color:#8e8e93;margin-top:2px}
    .stats-row{display:flex;gap:20px;font-size:15px}
    .stat-item{display:flex;align-items:center;gap:6px}
    .stat-value{font-weight:600}
    /* CALENDAR --------------------------------------------- */
    .calendar-section{background:#fff;margin:16px;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .month-navigation{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .month-title{font-size:18px;font-weight:600;text-transform:capitalize}
    .nav-btn{width:36px;height:36px;border:none;background:#007aff;color:#fff;border-radius:50%;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity .2s}
    .nav-btn:active{opacity:.7}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .weekday-label{text-align:center;font-size:12px;color:#8e8e93;font-weight:500;padding:8px 0}
    .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;background:#f2f2f7;cursor:pointer;position:relative;transition:all .2s}
    .calendar-day:active{transform:scale(.95)}
    .calendar-day.other-month{opacity:.3}
    .calendar-day.today{background:#e5f1ff;color:#007aff;font-weight:600}
    .calendar-day.selected{background:#007aff;color:#fff}
    .day-number{font-size:15px}
    .task-dots{position:absolute;bottom:4px;display:flex;gap:2px}
    .task-dot{width:4px;height:4px;border-radius:2px;background:#8e8e93}
    .task-dot.completed{background:#34c759}
    /* TASKS ------------------------------------------------- */
    .tasks-section{margin:16px}
    .tasks-header{font-size:20px;font-weight:600;margin-bottom:16px;padding:0 4px}
    .task-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;align-items:flex-start;gap:12px;transition:opacity .2s}
    .task-card.completed{opacity:.6}
    .checkbox{width:24px;height:24px;border:2px solid #007aff;border-radius:6px;cursor:pointer;flex-shrink:0;position:relative;transition:all .2s;user-select:none}
    .checkbox.checked{background:#007aff;border-color:#007aff}
    .checkbox.checked::after{content:'';position:absolute;left:7px;top:3px;width:6px;height:12px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}
    .task-title{font-size:16px;font-weight:500;line-height:1.3;margin-bottom:6px}
    .task-title.completed{text-decoration:line-through}
    .task-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:13px;color:#8e8e93}
    .priority-badge{padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500;color:#fff}
    .priority-high{background:#ff3b30}.priority-medium{background:#ff9500}.priority-low{background:#34c759}
    .empty-state{text-align:center;padding:60px 20px;color:#8e8e93}
    .empty-icon{font-size:64px;margin-bottom:16px;opacity:.5}
    /* LOADING ----------------------------------------------- */
    .loading-container{display:flex;justify-content:center;align-items:center;min-height:200px}
    .spinner{width:40px;height:40px;border:3px solid #f2f2f7;border-top-color:#007aff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* FAB --------------------------------------------------- */
    .fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:#007aff;color:#fff;border:none;border-radius:28px;font-size:28px;box-shadow:0 4px 12px rgba(0,122,255,.3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s;z-index:1000}
    .fab:active{transform:scale(.9)}
    .error-message{background:#ff3b30;color:#fff;padding:12px 16px;margin:16px;border-radius:8px;font-size:14px}
  </style>
</head>
<body>
<div id="app" class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="user-info">
      <div class="avatar" id="userAvatar">–£</div>
      <div>
        <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <div class="user-rank" id="userRank">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-item">üèÜ¬†<span class="stat-value" id="userPoints">0</span></div>
      <div class="stat-item">üî•¬†<span class="stat-value" id="userStreak">0</span>¬†–¥–Ω–µ–π</div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div class="calendar-section">
    <div class="month-navigation">
      <button class="nav-btn" onclick="changeMonth(-1)">‚Üê</button>
      <div class="month-title" id="monthTitle">‚Ä¶</div>
      <button class="nav-btn" onclick="changeMonth(1)">‚Üí</button>
    </div>
    <div class="calendar-grid" id="calendar"></div>
  </div>

  <!-- TASKS -->
  <div class="tasks-section">
    <div class="tasks-header" id="tasksHeader">–ó–∞–¥–∞—á–∏ –Ω–∞¬†—Å–µ–≥–æ–¥–Ω—è</div>
    <div id="tasksList"><div class="loading-container"><div class="spinner"></div></div></div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="addNewTask()">Ôºã</button>
</div>

<script>
/***** CONFIG *****/
const API={
  user:'https://nbykanov13.app.n8n.cloud/webhook/ec48838c-e168-4f0e-bf66-054d59e0275a/api/user',
  tasks:'https://nbykanov13.app.n8n.cloud/webhook/2fd6cb69-88fa-4d08-aba2-221247b6652b/api/tasks',
  calendar:'https://nbykanov13.app.n8n.cloud/webhook/a8c27692-17b1-45f8-a11f-0e5a7063a5ed/api/calendar',
  toggle:'https://nbykanov13.app.n8n.cloud/webhook/a3911d71-ce2f-4e9c-a05d-f35f1c4779c8/api/tasks'
};

/***** TELEGRAM INIT *****/
let tg=null,userId=null;
if(window.Telegram && window.Telegram.WebApp){tg=window.Telegram.WebApp;tg.ready();tg.expand();if(tg.initDataUnsafe && tg.initDataUnsafe.user){userId=tg.initDataUnsafe.user.id;}}
if(!userId){const p=new URLSearchParams(location.search);userId=parseInt(p.get('user_id'))||123456789;}

/***** STATE *****/
const today=new Date();
let currentDate=new Date(),selectedDate=new Date();
let calendarData={},tasks=[],user={first_name:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',rank:'–ö–æ–∂–∞–Ω—ã–π –º–µ—à–æ–∫',points:0,current_streak:0};

/***** HELPERS *****/
const $=id=>document.getElementById(id);
const fmtKey=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
function api(url,opt={}){return fetch(url,{headers:{'Content-Type':'application/json'},...opt}).then(r=>{if(!r.ok)throw Error(r.status);return r.json();});}
function haptic(type){try{tg?.HapticFeedback?.impactOccurred(type);}catch{}}

/***** LOADERS *****/
async function loadUser(){try{const data=await api(`${API.user}/${userId}`);const u=Array.isArray(data)?data[0]:data;Object.assign(user,u);updateUser();}catch{}}
async function loadCalendar(){try{const y=currentDate.getFullYear(),m=currentDate.getMonth()+1;const data=await api(`${API.calendar}/${userId}/${y}/${m}`);calendarData={};(Array.isArray(data)?data:[data]).filter(Boolean).forEach(d=>{calendarData[fmtKey(new Date(d.date))]={total:+d.total_tasks||0,completed:+d.completed_tasks||0};});}catch{calendarData={}}renderCalendar();}
async function loadTasks(){try{
